---
import Layout from '../../../layouts/Layout.astro';
import PageBuilder from '../../../components/PageBuilder.astro';
import { loadQuery } from '../../../sanity/lib/load-query';
import { PAGE_QUERY, SITE_SETTINGS_QUERY } from '../../../sanity/lib/queries';

export const prerender = false;

const { lang, slug } = Astro.params;

let page: any = null;
let settings: any = null;
let error: string | null = null;

try {
  const [pageResult, settingsResult] = await Promise.all([
    loadQuery<any>({
      query: PAGE_QUERY,
      params: { language: lang, slug: slug || '' },
      preview: true,
    }),
    loadQuery<any>({
      query: SITE_SETTINGS_QUERY,
      preview: true,
    }),
  ]);
  page = pageResult.data;
  settings = settingsResult.data;
} catch (e) {
  error = e instanceof Error ? e.message : String(e);
}

if (!page && !error) {
  return Astro.redirect('/fr/accueil');
}
---

{error ? (
  <html>
    <body>
      <h1>Preview Error</h1>
      <p>Lang: {lang}, Slug: {slug}</p>
      <pre>{error}</pre>
    </body>
  </html>
) : (
  <Layout
    title={page.seoTitle || page.title}
    description={page.seoDescription}
    lang={lang}
    noIndex={true}
    translations={page.translations}
    currentSlug={slug}
    preview={true}
    settings={settings}
  >
    <main>
      {page.content && <PageBuilder sections={page.content} />}
    </main>
  </Layout>
)}
