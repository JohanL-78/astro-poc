---
import Layout from '../../layouts/Layout.astro';
import PageBuilder from '../../components/PageBuilder.astro';
import { loadQuery } from '../../sanity/lib/load-query';
import { ALL_PAGES_QUERY, PAGE_QUERY, SITE_SETTINGS_QUERY } from '../../sanity/lib/queries';

export const prerender = true;

export async function getStaticPaths() {
  const { data: pages } = await loadQuery<{ slug: string; language: string }[]>({
    query: ALL_PAGES_QUERY,
  });

  return pages.map((p) => ({
    params: { lang: p.language, slug: p.slug },
  }));
}

const { lang, slug } = Astro.params;

const [{ data: page }, { data: settings }] = await Promise.all([
  loadQuery<any>({
    query: PAGE_QUERY,
    params: { language: lang, slug: slug || '' },
  }),
  loadQuery<any>({
    query: SITE_SETTINGS_QUERY,
  }),
]);

if (!page) {
  return Astro.redirect('/fr/accueil');
}
---

<Layout
  title={page.seoTitle || page.title}
  description={page.seoDescription}
  lang={lang}
  noIndex={page.noIndex}
  translations={page.translations}
  currentSlug={slug}
  settings={settings}
>
  <main>
    {page.content && <PageBuilder sections={page.content} />}
  </main>
</Layout>
